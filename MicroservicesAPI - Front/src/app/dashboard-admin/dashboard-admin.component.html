<div class="admin-panel">
  <nav class="sidebar">
    <ul>
      <li [class.active]="selectedTab === 'users'" (click)="selectedTab = 'users'">Utilisateurs</li>
      <li [class.active]="selectedTab === 'stores'" (click)="selectedTab = 'stores'">Boutiques</li>
      <li [class.active]="selectedTab === 'products'" (click)="selectedTab = 'products'">Produits</li>
      <li [class.active]="selectedTab === 'categories'" (click)="selectedTab = 'categories'">Catégories</li>
    </ul>
  </nav>

  <div class="content" [ngSwitch]="selectedTab">

    <!-- Utilisateurs -->
    <div *ngSwitchCase="'users'">
      <h2>Utilisateurs</h2>
      <table class="admin-table" *ngIf="users.length > 0">
        <tr>
          <th>Actions</th>
          <ng-container *ngFor="let key of objectKeys(users[0])">
            <th *ngIf="key !== '_id' && key !== 'googleId' && key !== 'passwordHash'">{{ headerLabel(key) }}</th>
          </ng-container>
        </tr>
        <tr *ngFor="let user of users.slice().reverse()">
          <td>
            <div class="action-buttons">
              <button (click)="openEditModal('user', user)">Modifier</button>
              <button class="delete-btn" (click)="deleteUser(user._id)">Supprimer</button>
            </div>
          </td>
          <ng-container *ngFor="let key of objectKeys(user)">
            <td *ngIf="key !== '_id' && key !== 'googleId' && key !== 'passwordHash'">
              <ng-container *ngIf="key === 'role'; else defaultUserCell">
                {{ getRoleLabel(user.role) }}
              </ng-container>
              <ng-template #defaultUserCell>
                {{ user[key] }}
              </ng-template>
            </td>
          </ng-container>
        </tr>
      </table>
    </div>

    <!-- Boutiques -->
    <div *ngSwitchCase="'stores'">
      <h2>Boutiques</h2>
      <table class="admin-table" *ngIf="stores.length > 0">
        <tr>
          <th>Actions</th>
          <ng-container *ngFor="let key of objectKeys(stores[0])">
            <th *ngIf="key !== '_id' && key !== 'updatedAt'">{{ headerLabel(key) }}</th>
          </ng-container>
          <th>Modifié le</th>
        </tr>
        <tr *ngFor="let store of stores.slice().reverse()">
          <td>
            <div class="action-buttons">
              <button (click)="openEditModal('store', store)">Modifier</button>
              <button class="delete-btn" (click)="deleteStore(store._id)">Supprimer</button>
            </div>
          </td>
          <ng-container *ngFor="let key of objectKeys(store)">
            <td *ngIf="key !== '_id' && key !== 'updatedAt'" class="image">
              <ng-container *ngIf="key === 'logo'; else storeSpecialCells">
                <img [src]="store.logo" alt="logo" style="cursor:pointer" (click)="openImageModal(store.logo)" />
              </ng-container>
              <ng-template #storeSpecialCells>
                <ng-container *ngIf="key === 'userId'; else storeDateCell">
                  {{ getUserName(store.userId) }}
                </ng-container>
                <ng-template #storeDateCell>
                  <ng-container *ngIf="key === 'createdAt'; else defaultStoreCell">
                    {{ store.createdAt | date:'dd/MM/yyyy HH:mm' : 'fr-FR' }}
                  </ng-container>
                  <ng-template #defaultStoreCell>
                    {{ store[key] }}
                  </ng-template>
                </ng-template>
              </ng-template>
            </td>
          </ng-container>
          <td>
            {{ store.updatedAt ? (store.updatedAt | date:'dd/MM/yyyy HH:mm' : 'fr-FR') : '' }}
          </td>
        </tr>
      </table>
    </div>

    <!-- Produits -->
    <div *ngSwitchCase="'products'">
      <h2>Produits</h2>
      <table class="admin-table" *ngIf="products.length > 0">
        <tr>
          <th>Actions</th>
          <ng-container *ngFor="let key of objectKeys(products[0])">
            <th *ngIf="key !== '_id' && key !== 'customFields' && key !== 'updatedAt'">{{ headerLabel(key) }}</th>
          </ng-container>
          <th>Modifié le</th>
        </tr>
        <tr *ngFor="let product of products.slice().reverse()">
          <td>
            <div class="action-buttons">
              <button (click)="openEditModal('product', product)">Modifier</button>
              <button class="delete-btn" (click)="deleteProduct(product._id)">Supprimer</button>
            </div>
          </td>
          <ng-container *ngFor="let key of objectKeys(product)">
            <td *ngIf="key !== '_id' && key !== 'customFields' && key !== 'updatedAt'" class="image">
              <ng-container *ngIf="key === 'image'; else productSpecialCells">
                <img [src]="product.image" alt="image" style="cursor:pointer" (click)="openImageModal(product.image)" />
              </ng-container>
              <ng-template #productSpecialCells>
                <ng-container *ngIf="key === 'storeId'; else productCategoryCell">
                  {{ getStoreName(product.storeId) }}
                </ng-container>
                <ng-template #productCategoryCell>
                  <ng-container *ngIf="key === 'categoryId'; else defaultProductCell">
                    {{ getCategoryName(product.categoryId) }}
                  </ng-container>
                  <ng-template #defaultProductCell>
                    {{ product[key] }}
                  </ng-template>
                </ng-template>
              </ng-template>
            </td>
          </ng-container>
          <td>
            {{ product.updatedAt ? (product.updatedAt | date:'dd/MM/yyyy HH:mm' : 'fr-FR') : '' }}
          </td>
        </tr>
      </table>
    </div>

    <!-- Catégories -->
    <div *ngSwitchCase="'categories'">
      <h2>Catégories</h2>
      <table class="admin-table" *ngIf="categorys.length > 0">
        <tr>
          <th>Actions</th>
          <ng-container *ngFor="let key of objectKeys(categorys[0])">
            <th *ngIf="key !== '_id'">{{ headerLabel(key) }}</th>
          </ng-container>
        </tr>
        <tr *ngFor="let category of categorys.slice().reverse()">
          <td>
            <div class="action-buttons">
              <button (click)="openEditModal('category', category)">Modifier</button>
              <button class="delete-btn" (click)="deleteCategory(category._id)">Supprimer</button>
            </div>
          </td>
          <ng-container *ngFor="let key of objectKeys(category)">
            <td *ngIf="key !== '_id'">
              {{ category[key] }}
            </td>
          </ng-container>
        </tr>
      </table>
    </div>
  </div>

  <!-- Modification -->
  <div class="overlay" *ngIf="showEditModal">
    <div class="modal">
      <h2>Modifier {{ editType | titlecase }}</h2>
      <form (ngSubmit)="submitEdit()">
        <div *ngFor="let field of editFields">
          <label>{{ field.label }}</label>
          <ng-container *ngIf="field.key === 'description'; else otherInputs">
            <textarea [(ngModel)]="editItem[field.key]" [name]="field.key" required></textarea>
          </ng-container>
          <ng-template #otherInputs>
            <ng-container *ngIf="editType === 'product' && field.key === 'categoryId'; else userRoleOrDefault">
              <select [(ngModel)]="editItem.categoryId" [name]="field.key" required>
                <option *ngFor="let cat of categorys" [value]="cat._id">{{ cat.name }}</option>
              </select>
            </ng-container>
            <ng-template #userRoleOrDefault>
              <ng-container *ngIf="editType === 'user' && field.key === 'role'; else defaultInput">
                <select [(ngModel)]="editItem.role" [name]="field.key" required>
                  <option value="user">Client</option>
                  <option value="seller">Vendeur</option>
                </select>
              </ng-container>
              <ng-template #defaultInput>
                <input [(ngModel)]="editItem[field.key]" [name]="field.key" required />
              </ng-template>
            </ng-template>
          </ng-template>
        </div>
        <div class="form-buttons">
          <button type="submit">Enregistrer</button>
          <button type="button" (click)="closeEditModal()">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Image grossit -->
  <div class="overlay" *ngIf="showImageModal" (click)="closeImageModal()">
    <div class="modal image-modal" (click)="$event.stopPropagation()">
      <img [src]="selectedImageUrl" alt="Aperçu" />
      <button class="close-btn" (click)="closeImageModal()">Fermer</button>
    </div>
  </div>
</div>