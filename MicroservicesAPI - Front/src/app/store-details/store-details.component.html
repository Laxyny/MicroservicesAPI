<div class="store-wrapper" *ngIf="store; else loading">
    <div class="store-details-container">
        <div class="store-header">
            <img [src]="store.logo" alt="Logo boutique" class="store-logo" />
            <div class="store-header-info">
                <h1 class="store-name">{{ store.name }}</h1>
                <p class="store-date">Rejoint le {{ store.createdAt | date: 'dd/MM/yyyy' }}</p>
            </div>
        </div>

        <div class="store-info">
            <p class="description">{{ store.description }}</p>
            <p class="website">
                <strong>Site web : </strong>
                <a [href]="store.site.startsWith('http') ? store.site : 'https://' + store.site" target="_blank"
                    rel="noopener noreferrer" class="store-site-link">
                    {{ store.site }}
                </a>
            </p>
            <div *ngIf="isOwner">
                <button (click)="deleteStore()" class="delete-btn">Supprimer cette boutique</button>
                <button (click)="toggleProductForm()" class="createProduct-btn">Ajouter un produit</button>
            </div>
        </div>
    </div>


    
    <div class="reports-section" *ngIf="isOwner">
        <h2>Rapports de la boutique</h2>

        <div class="report-tabs">
            <button [class.active]="reportTab === 'schedule'" (click)="reportTab = 'schedule'">Configuration</button>
            <button [class.active]="reportTab === 'history'" (click)="reportTab = 'history'">Historique</button>
        </div>

        <div class="report-content" *ngIf="reportTab === 'schedule'">
            <h3>Rapports automatisés</h3>
            <form (ngSubmit)="saveReportSchedule()" #scheduleForm="ngForm">
                <div class="form-group">
                    <label>Fréquence des rapports</label>
                    <select [(ngModel)]="reportSchedule.frequency" name="frequency" required>
                        <option value="never">Désactivé</option>
                        <option value="daily">Quotidien</option>
                        <option value="weekly">Hebdomadaire</option>
                        <option value="monthly">Mensuel</option>
                    </select>
                </div>

                <div class="form-group" *ngIf="reportSchedule.frequency === 'weekly'">
                    <label>Jour de la semaine</label>
                    <select [(ngModel)]="reportSchedule.dayOfWeek" name="dayOfWeek" required>
                        <option [value]="0">Lundi</option>
                        <option [value]="1">Mardi</option>
                        <option [value]="2">Mercredi</option>
                        <option [value]="3">Jeudi</option>
                        <option [value]="4">Vendredi</option>
                        <option [value]="5">Samedi</option>
                        <option [value]="6">Dimanche</option>
                    </select>
                </div>

                <div class="form-group" *ngIf="reportSchedule.frequency === 'monthly'">
                    <label>Jour du mois</label>
                    <select [(ngModel)]="reportSchedule.dayOfMonth" name="dayOfMonth" required>
                        <option *ngFor="let day of daysOfMonth" [value]="day">{{ day }}</option>
                    </select>
                </div>

                <!-- <div class="form-group">
                    <label>Options du rapport</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeProducts" [(ngModel)]="reportSchedule.includeProducts"
                            name="includeProducts">
                        <label for="includeProducts">Inclure les produits</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeCharts" [(ngModel)]="reportSchedule.includeCharts"
                            name="includeCharts">
                        <label for="includeCharts">Inclure les graphiques</label>
                    </div>
                </div> -->

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Enregistrer</button>
                    <button type="button" class="btn-secondary" (click)="generateReportNow()">Générer un rapport
                        maintenant</button>
                </div>
            </form>
        </div>

        <div class="report-content" *ngIf="reportTab === 'history'">
            <h3>Historique des rapports</h3>

            <div class="report-list">
                <div class="report-item" *ngFor="let report of reportHistory">
                    <div class="report-info">
                        <span class="report-date">{{ report.generatedAt | date: 'dd/MM/yyyy HH:mm':'UTC+4' }}</span>
                        <span class="report-type" [ngClass]="report.type">{{
                            report.type === 'scheduled' ? 'Automatique' : 'Manuel' }}</span>
                    </div>
                    <button class="download-btn" (click)="downloadReport(report.reportId)">
                        <i class="fas fa-download"></i> Télécharger
                    </button>
                </div>

                <p *ngIf="reportHistory.length === 0" class="no-reports">
                    Aucun rapport n'a encore été généré.
                </p>
            </div>
        </div>
    </div>




    <div class="overlay" *ngIf="showAddProductForm">
        <div class="modal">
            <h2>Créer un produit</h2>

            <form (ngSubmit)="submitProduct()" #productForm="ngForm">
                <label>Nom du produit</label>
                <input type="text" [(ngModel)]="productName" name="name" required maxlength="30" />

                <label>Description</label>
                <input type="text" [(ngModel)]="productDescription" name="description" required maxlength="255" />

                <label>Prix (€)</label>
                <input type="number" [(ngModel)]="productPrice" name="price" min="0" max="1000000" required />

                <div class="custom-fields-section">
                    <h3>Champs personnalisés</h3>

                    <div *ngFor="let field of customFields; let i = index" class="custom-field-row">
                        <div class="field-inputs">
                            <input type="text" [(ngModel)]="field.key" name="fieldKey{{i}}" placeholder="Nom du champ"
                                required />
                            <input type="text" [(ngModel)]="field.value" name="fieldValue{{i}}" placeholder="Valeur"
                                required />
                        </div>
                        <button type="button" class="remove-field-btn" (click)="removeCustomField(i)">×</button>
                    </div>

                    <button type="button" class="add-field-btn" (click)="addCustomField()">
                        + Ajouter un champ personnalisé
                    </button>
                </div>

                <label>Catégorie</label>
                <div class="category-dropdown-wrapper">
                    <input type="text" placeholder="Rechercher une catégorie..." [(ngModel)]="categorySearch"
                        (focus)="showCategoryDropdown = true" (input)="filterCategories()" name="categorySearch" />

                    <div class="dropdown-category-list" *ngIf="showCategoryDropdown">
                        <div class="dropdown-item" *ngFor="let category of filteredCategories"
                            (click)="selectCategory(category)">
                            {{ category.name }}
                        </div>

                        <div class="create-category">
                            <input type="text" placeholder="Créer une nouvelle catégorie" [(ngModel)]="newCategoryName"
                                name="newCategoryName" />
                            <button type="button" (click)="createCategory()">Créer</button>
                        </div>
                    </div>
                </div>

                <label>Image (225 x 160)</label>
                <input type="file" id="avatar" name="avatar" (change)="onFileSelected($event)"
                    accept="image/png, image/jpeg" required />

                <small class="field-error" *ngIf="image === null">
                    Veuillez sélectionner une image.
                </small>

                <div class="form-buttons">
                    <button [disabled]="!isFormValid()" [ngClass]="{ 'disabled-btn': !isFormValid() }">
                        Ajouter le produit
                    </button>
                    <button type="button" class="cancel" (click)="toggleProductForm()">Annuler</button>
                </div>
            </form>
        </div>
    </div>
</div>



<section class="product-list-section">
    <h2>Produits vendus par {{ store.name }}</h2>

    <div *ngIf="products.length > 0; else noProducts" class="product-grid">
        <div class="product-card" *ngFor="let product of products" (click)="goToProductDetails(product._id)">
            <div class="image-wrapper">
                <img [src]="product.image" alt="{{ product.name }}" class="product-image" />
            </div>
            <div class="product-details">
                <h3>{{ product.name }}</h3>
                <p class="description">{{ product.description }}</p>
                <p class="price">{{ product.price }} €</p>
            </div>
            <button>Voir</button>
        </div>
    </div>

    <ng-template #noProducts>
        <p class="info">Aucun produit disponible pour le moment.</p>
    </ng-template>
</section>

<ng-template #loading>
    <p class="loading-text">Chargement des détails de la boutique...</p>
</ng-template>